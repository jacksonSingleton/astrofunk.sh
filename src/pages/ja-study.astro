---
import BaseHead from "../components/BaseHead.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import KanjiGrid from "../components/KanjiGrid.astro";
import "../styles/ja-study.css";

// Calculate tutoring hours
const START_DATE = new Date("2025-10-20");
const START_HOURS = 67;
const TUTORING_DAYS = [1, 3, 5];

function calculateTutoringHours() {
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    let currentDate = new Date(START_DATE);
    currentDate.setHours(0, 0, 0, 0);

    let additionalHours = 0;

    while (currentDate <= today) {
        const dayOfWeek = currentDate.getDay();
        if (TUTORING_DAYS.includes(dayOfWeek)) {
            additionalHours++;
        }
        currentDate.setDate(currentDate.getDate() + 1);
    }

    return START_HOURS + additionalHours;
}

const totalHours = calculateTutoringHours();

let ankiCount = 0;
try {
    const response = await fetch("https://anki-counter.fly.dev/count");
    if (response.ok) {
        const data = await response.json();
        ankiCount = data.count || 0;
    }
} catch (error) {
    console.error("Failed to fetch Anki count:", error);
}

// Fetch AniList data
const ANILIST_USERNAME = "astrofunk"; // Replace with your AniList username

async function fetchAniListMedia(type: "ANIME" | "MANGA") {
    const query = `
    query ($userName: String, $type: MediaType, $status: MediaListStatus) {
      MediaListCollection(userName: $userName, type: $type, status: $status) {
        lists {
          entries {
            media {
              id
              title {
                romaji
                english
              }
              coverImage {
                large
              }
              siteUrl
            }
            progress
          }
        }
      }
    }
  `;

    try {
        const response = await fetch("https://graphql.anilist.co", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                query,
                variables: {
                    userName: ANILIST_USERNAME,
                    type: type,
                    status: "CURRENT",
                },
            }),
        });

        if (response.ok) {
            const data = await response.json();
            const entries =
                data.data?.MediaListCollection?.lists?.[0]?.entries || [];
            return entries.map((entry: any) => ({
                id: entry.media.id,
                title: entry.media.title.english || entry.media.title.romaji,
                coverImage: entry.media.coverImage.large,
                siteUrl: entry.media.siteUrl,
                progress: entry.progress,
            }));
        }
    } catch (error) {
        console.error(`Failed to fetch AniList ${type}:`, error);
    }
    return [];
}

const currentlyWatching = await fetchAniListMedia("ANIME");
const currentlyReading = await fetchAniListMedia("MANGA");
---

<html lang="en">
    <head>
        <BaseHead
            title={"Japanese Progress"}
            description={"My progress of studying japanese"}
        />
        <Header />

        <script
            async
            src="https://www.googletagmanager.com/gtag/js?id=G-QJPVFD5YTY"
        ></script><script is:inline>
            window.dataLayer = window.dataLayer || [];
            function gtag() {
                dataLayer.push(arguments);
            }
            gtag("js", new Date());

            gtag("config", "G-QJPVFD5YTY");
        </script></head
    >

    <!-- Google tag (gtag.js) -->

    <body>
        <main>
            <div class="tutoring-section">
                <h1>Japanese Study Progress</h1>
                <div class="stats-container">
                    <div class="tutoring-card">
                        <div class="tutoring-hours">
                            {totalHours}
                        </div>
                        <div class="tutoring-label">Total Tutoring Hours</div>
                    </div>
                    <div class="tutoring-card">
                        <div class="tutoring-hours">
                            {ankiCount.toLocaleString()}
                        </div>
                        <div class="tutoring-label">Flashcards Reviewed</div>
                    </div>
                </div>
            </div>

            {
                (currentlyWatching.length > 0 ||
                    currentlyReading.length > 0) && (
                    <div class="anilist-section">
                        {currentlyWatching.length > 0 && (
                            <div class="media-category">
                                <h2>Currently Watching</h2>
                                <div class="media-grid">
                                    {currentlyWatching.map((anime) => (
                                        <a
                                            href={anime.siteUrl}
                                            target="_blank"
                                            rel="noopener noreferrer"
                                            class="media-card"
                                        >
                                            <img
                                                src={anime.coverImage}
                                                alt={anime.title}
                                                loading="lazy"
                                            />
                                            <div class="media-title">
                                                {anime.title}
                                            </div>
                                        </a>
                                    ))}
                                </div>
                            </div>
                        )}

                        {currentlyReading.length > 0 && (
                            <div class="media-category">
                                <h2>Currently Reading</h2>
                                <div class="media-grid">
                                    {currentlyReading.map((manga) => (
                                        <a
                                            href={manga.siteUrl}
                                            target="_blank"
                                            rel="noopener noreferrer"
                                            class="media-card"
                                        >
                                            <img
                                                src={manga.coverImage}
                                                alt={manga.title}
                                                loading="lazy"
                                            />
                                            <div class="media-title">
                                                {manga.title}
                                            </div>
                                        </a>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                )
            }

            <KanjiGrid />
        </main>
        <Footer />
    </body>
</html>
